name: ci

env:
  GO_VERSION: 1.24.4

on:
  pull_request:
    branches: [ "**" ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/ci.yml'

jobs:

  golangci-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7.2

  codespell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: codespell-project/actions-codespell@v2
        with:
          ignore_words_file: .codespellignore

  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: windows
            goarch: amd64
          - goos: linux
            goarch: arm64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Build via GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          args: build --snapshot --clean --single-target
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: dist-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/

  test-linux:
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            runner: ubuntu-latest
          - goos: linux
            goarch: arm64
            runner: ubuntu-24.04-arm
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
      - name: Download Artifact
        uses: actions/download-artifact@v7
        with:
          name: dist-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/
      - name: Run tests
        shell: bash
        run: |
          EXECUTABLE=$(pwd)/$(find dist/ -path "*${{ matrix.goos }}*${{ matrix.goarch }}*" -name dingopie -type f | head -n 1)
          if [ -z "$EXECUTABLE" ]; then
            echo "Error: Could not find dingopie binary in dist/"
            exit 1
          fi
          echo "dingopie binary found at: $EXECUTABLE"
          chmod +x $EXECUTABLE
          make test EXECUTABLE=$EXECUTABLE

  test-windows:
    runs-on: windows-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: dist-windows-amd64
          path: dist/
      - name: Run tests
        run: |
          $exe = (Resolve-Path .\dist\dingopie_windows_amd64_v1\dingopie.exe).Path
          $exe = $exe -replace '\\', '/'
          echo "dingopie binary found at: $exe"
          make test-windows EXECUTABLE="$exe"
        shell: pwsh
